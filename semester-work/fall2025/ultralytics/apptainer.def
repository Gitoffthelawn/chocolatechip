Bootstrap: docker
From: ultralytics/ultralytics:latest

%environment
    export DEBIAN_FRONTEND=noninteractive

%files
    src                                                 /ultralytics/src
    semester-work/fall2025/ultralytics/LegoGears_v2      /ultralytics/LegoGears_v2
    semester-work/fall2025/ultralytics/LG_v2.yaml       /ultralytics/LG_v2.yaml

%post
    cd /ultralytics

    apt-get update 
    apt-get install -y --no-install-recommends fio

    # Install the required Python packages in the virtual environment
    pip install --upgrade pip
    pip install --no-cache-dir cloudmesh-common git+https://github.com/cloudmesh/cloudmesh-gpu.git 

    #user
    groupadd -g 1000 appgroup && \
    useradd -m -u 1000 -g 1000 -s /bin/bash appuser

    #dataset setup 
    python -m chocolatechip.model_training.dataset_setup \
        --root /ultralytics/LegoGears_v2 \
        --sets set_01 set_02_empty set_03 \
        --classes 5 \
        --names LegoGears.names \
        --prefix LegoGears

    #ownership
    mkdir -p /ultralytics/outputs /ultralytics/.cache && \
    chown -R appuser:appgroup /ultralytics
    rm -rf /var/lib/apt/lists/*

%runscript
    # This is the only command that runs when the container starts
    exec bash -lc "python -u -m chocolatechip.model_training.train --profile LegoGearsUltra"